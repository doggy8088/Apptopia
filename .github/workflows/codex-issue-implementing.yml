name: Issue Implementing with Codex CLI

on:
  schedule:
    - cron: "30 */6 * * *" # Every 6 hours (UTC), offset from planning workflow
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: codex-issue-implementing
  cancel-in-progress: false

jobs:
  implement-latest-accepted-issue:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Validate required secrets
        env:
          AZURE_OPENAI_API_KEY_CODEX: ${{ secrets.AZURE_OPENAI_API_KEY_CODEX }}
          CODEX_GITHUB_TOKEN: ${{ secrets.CODEX_GITHUB_TOKEN }}
        run: |
          missing=0

          if [ -z "$AZURE_OPENAI_API_KEY_CODEX" ]; then
            echo "Missing required secret: AZURE_OPENAI_API_KEY_CODEX"
            missing=1
          fi

          if [ -z "$CODEX_GITHUB_TOKEN" ]; then
            echo "Missing required secret: CODEX_GITHUB_TOKEN"
            echo "This token must be able to push workflow files under .github/workflows/."
            echo "Use a token with workflow write access (for example: classic PAT with repo + workflow scopes)."
            missing=1
          fi

          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CODEX_GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Prepare git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create Codex config for Azure
        run: |
          mkdir -p ~/.codex
          cat <<EOT > ~/.codex/config.toml
          approval_policy = "on-request"
          sandbox_mode   = "workspace-write"

          profile = "aoai"

          [features]
          multi_agent = true
          steer = true

          #####################
          ### Azure Foundry ###
          #####################

          [model_providers.azure]
          name         = "Azure OpenAI"
          base_url     = "https://duotify-ai-foundry.cognitiveservices.azure.com/openai"
          env_key      = "AZURE_OPENAI_API_KEY_CODEX"
          wire_api     = "responses"
          query_params = { api-version = "2025-04-01-preview" }

          [profiles.aoai]
          model_provider          = "azure"
          model                   = "gpt-5.2-codex"
          preferred_auth_method   = "apikey"
          wire_api                = "responses"
          model_reasoning_effort  = "high"
          model_reasoning_summary = "detailed"
          EOT

      - name: Pick latest open accepted issue and branch name
        id: pick
        env:
          GH_TOKEN: ${{ secrets.CODEX_GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          set -euo pipefail

          echo "::group::Pick step debug context"
          echo "Repository: $GH_REPO"
          echo "Run number: $GITHUB_RUN_NUMBER"
          echo "Workflow trigger: ${{ github.event_name }}"
          echo "Query: open issues with label=accepted sorted by created desc"
          echo "::endgroup::"

          echo "::group::Candidate accepted issues (top 5)"
          gh issue list \
            --repo "$GH_REPO" \
            --state open \
            --label accepted \
            --search "sort:created-desc" \
            --limit 5 \
            --json number,title,url,createdAt \
          | jq '.'
          echo "::endgroup::"

          ISSUE_JSON="$(gh issue list \
            --repo "$GH_REPO" \
            --state open \
            --label accepted \
            --search "sort:created-desc" \
            --limit 1 \
            --json number,title,url,createdAt)"

          ISSUE_COUNT="$(echo "$ISSUE_JSON" | jq 'length')"
          echo "::group::Selected issue query result (top 1)"
          echo "$ISSUE_JSON" | jq '.'
          echo "ISSUE_COUNT=$ISSUE_COUNT"
          echo "::endgroup::"

          if [ "$ISSUE_COUNT" -eq 0 ]; then
            echo "No open accepted issue found. Implement step will be skipped."
            echo "issue_exists=false" >> "$GITHUB_OUTPUT"
            echo "skip_reason=no-accepted-issue" >> "$GITHUB_OUTPUT"
            echo "has_open_pr=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ISSUE_NUMBER="$(echo "$ISSUE_JSON" | jq -r '.[0].number')"
          ISSUE_TITLE="$(echo "$ISSUE_JSON" | jq -r '.[0].title')"
          ISSUE_URL="$(echo "$ISSUE_JSON" | jq -r '.[0].url')"
          ISSUE_CREATED_AT="$(echo "$ISSUE_JSON" | jq -r '.[0].createdAt')"

          echo "::group::Selected issue details"
          echo "ISSUE_NUMBER=$ISSUE_NUMBER"
          echo "ISSUE_TITLE=$ISSUE_TITLE"
          echo "ISSUE_URL=$ISSUE_URL"
          echo "ISSUE_CREATED_AT=$ISSUE_CREATED_AT"
          echo "::endgroup::"

          MATCHING_PRS_JSON="$(gh pr list \
            --repo "$GH_REPO" \
            --state open \
            --search "is:open is:pr repo:$GH_REPO \"#${ISSUE_NUMBER}\" in:body" \
            --json number,title,url,headRefName,state)"
          MATCHING_PR_COUNT="$(echo "$MATCHING_PRS_JSON" | jq 'length')"
          EXISTING_PR_URL="$(echo "$MATCHING_PRS_JSON" | jq -r '.[0].url // empty')"

          echo "::group::Open PR check for selected issue"
          echo "PR search query: is:open is:pr repo:$GH_REPO \"#${ISSUE_NUMBER}\" in:body"
          echo "MATCHING_PR_COUNT=$MATCHING_PR_COUNT"
          echo "$MATCHING_PRS_JSON" | jq '.'
          echo "::endgroup::"

          if [ -n "$EXISTING_PR_URL" ]; then
            echo "Selected issue already has an open PR. Continue to Implement step for review-followup handling."
            echo "has_open_pr=true" >> "$GITHUB_OUTPUT"
            echo "existing_pr_url=$EXISTING_PR_URL" >> "$GITHUB_OUTPUT"
          else
            echo "No open PR linked by body reference for issue #$ISSUE_NUMBER."
            echo "has_open_pr=false" >> "$GITHUB_OUTPUT"
          fi

          ISSUE_SLUG="$(echo "$ISSUE_TITLE" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's/[^a-z0-9]+/-/g; s/^-+//; s/-+$//' \
            | cut -c1-42)"
          if [ -z "$ISSUE_SLUG" ]; then
            ISSUE_SLUG="accepted-issue"
          fi

          ISSUE_BRANCH="issue-${ISSUE_NUMBER}-${ISSUE_SLUG}"
          if git ls-remote --exit-code --heads origin "$ISSUE_BRANCH" >/dev/null 2>&1; then
            ISSUE_BRANCH="${ISSUE_BRANCH}-run-${GITHUB_RUN_NUMBER}"
          fi

          echo "::group::Computed branch"
          echo "ISSUE_BRANCH=$ISSUE_BRANCH"
          echo "::endgroup::"

          echo "issue_exists=true" >> "$GITHUB_OUTPUT"
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          echo "issue_title=$ISSUE_TITLE" >> "$GITHUB_OUTPUT"
          echo "issue_url=$ISSUE_URL" >> "$GITHUB_OUTPUT"
          echo "issue_branch=$ISSUE_BRANCH" >> "$GITHUB_OUTPUT"

      - name: Create working branch before implementation
        if: steps.pick.outputs.issue_exists == 'true'
        run: |
          git checkout -b "${{ steps.pick.outputs.issue_branch }}"

      - name: Implement latest accepted issue and open PR
        if: steps.pick.outputs.issue_exists == 'true'
        env:
          AZURE_OPENAI_API_KEY_CODEX: ${{ secrets.AZURE_OPENAI_API_KEY_CODEX }}
          GH_TOKEN: ${{ secrets.CODEX_GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ steps.pick.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.pick.outputs.issue_title }}
          ISSUE_URL: ${{ steps.pick.outputs.issue_url }}
          ISSUE_BRANCH: ${{ steps.pick.outputs.issue_branch }}
          HAS_OPEN_PR: ${{ steps.pick.outputs.has_open_pr }}
          EXISTING_PR_URL: ${{ steps.pick.outputs.existing_pr_url }}
        run: |
          codex exec --dangerously-bypass-approvals-and-sandbox --color never "
          你正在 GitHub Actions 中執行，請使用 gh CLI、git 與本地檔案操作完成任務。
          目標是處理最新一筆 open 且有 accepted 標籤的 Issue。
          本次目標 Issue 為 #$ISSUE_NUMBER：$ISSUE_TITLE
          Issue URL：$ISSUE_URL
          Pick 步驟偵測到既有 PR：$HAS_OPEN_PR
          若已有既有 PR，URL：${EXISTING_PR_URL:-無}
          請先完整閱讀 Issue 內容與留言，再依需求實作 App。

          目前已經建立好工作分支：$ISSUE_BRANCH。請在這個分支上開發，不要切回 main。

          請優先判斷目前這個 Issue 是否已經有 PR 在處理中？

          如果有，請查看 PR 狀態與留言，先確認是否有任何 Code Review 的事項需要處理，如果有，請切換到該 PR 的分支，逐一查閱 Code Review 留言，並依照留言內容修改程式碼，並提交變更後推送到該分支。完成 PR 建立之後，請到原 Issue 留言說明目前 PR 的狀態與後續計畫，並等待 Code Review 的結果。

          如果沒有，請直接開始實作，完成後再建立 PR。
          實作時請遵守 repo 根目錄 AGENTS.md 規範，至少包含：
          - App 放在 apps/issue-$ISSUE_NUMBER/
          - 補齊 apps/issue-$ISSUE_NUMBER/README.md（安裝、使用、測試、建置、部署、Issue 連結）
          - 建立或更新 .github/workflows/ci_$ISSUE_NUMBER.yml（只觸發 apps/issue-$ISSUE_NUMBER/** 與自身 workflow）

          開發完成後請執行必要測試與建置，確認可用。
          接著請：
          1. git add / commit（commit message 要清楚描述實作內容）
          2. git push origin $ISSUE_BRANCH
          3. 用 gh pr create 發 PR 到 main

          PR 內容要求：
          - 標題要有意義且包含 Issue #$ISSUE_NUMBER
          - 內文需包含 Summary、Validation（實際執行命令）、以及 Closes #$ISSUE_NUMBER

          若實作後沒有任何檔案變更，請不要建立 PR，改為在 Issue 留言說明原因。
          請直接執行，不要輸出額外說明。
          "

      - name: Report skipped run
        if: steps.pick.outputs.issue_exists != 'true'
        run: |
          echo "No implementation executed."
          echo "Reason: ${{ steps.pick.outputs.skip_reason }}"
          if [ "${{ steps.pick.outputs.skip_reason }}" = "already-has-open-pr" ]; then
            echo "Existing PR: ${{ steps.pick.outputs.existing_pr_url }}"
          fi
