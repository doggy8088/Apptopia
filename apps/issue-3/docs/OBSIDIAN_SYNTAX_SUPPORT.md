# Obsidian 語法支援矩陣

## 概述

本文件定義 AI知識++ V1 對 Obsidian 語法的支援策略，基於實際測試資料分析結果。

**測試資料來源**：`apps/issue-3/data/test-data/` (43 個 Markdown 文件)

**更新日期**：2026-02-17

---

## 語法分類

### ✅ 完整支援（Priority 1）

這些語法將被完整解析並保留其語意功能。

#### 1. YAML Frontmatter

**描述**：文件開頭的元數據區塊

**語法**：
```yaml
---
tags:
  - 程式語言/Rust
  - 學習筆記
aliases: 
  - Rust ownership
  - 所有權
來源:
  - "[[Rust 權威指南]]"
新建日期: 2024-02-12 17:47:00
---
```

**支援範圍**：
- ✅ `tags`: 提取並建立標籤索引
- ✅ `aliases`: 提取別名用於搜尋
- ✅ `來源` (自定義欄位): 提取作為參考來源
- ✅ `新建日期`: 提取作為文件時間戳記
- ✅ 其他自定義欄位：作為 metadata 儲存

**實作策略**：
- 使用 YAML parser 解析
- 提取到 Document metadata
- 標籤建立反向索引
- 日期用於排序與過濾

**測試案例**：
- 檔案：`Card卡片盒/學習/程式/Rust/Rust 所有權.md`
- 預期：tags 包含 "程式語言/Rust"，來源包含 "Rust 權威指南"

---

#### 2. Wikilinks（內部連結）

**描述**：Obsidian 的核心連結語法

##### 2.1 基本 Wikilink

**語法**：`[[文件名稱]]`

**範例**：
```markdown
[[Rust 所有權]]
[[C++ 指標]]
```

**支援範圍**：
- ✅ 識別連結目標文件
- ✅ 建立文件間關聯
- ✅ 用於知識圖譜邊的建立
- ✅ 點擊跳轉（UI 功能）

**實作策略**：
- 正則表達式：`\[\[([^\]|#]+?)\]\]`
- 建立 Document 間的 Relationship
- 關聯類型：`manual_link`，權重：0.2（參考 TECHNICAL_ARCHITECTURE.md）

**測試案例**：
- 檔案：`Atlas地圖集/MOC/Rust MOC.md`
- 預期：識別出 "Rust語言基本", "Rust Debug 技巧" 等連結

---

##### 2.2 Wikilink 帶顯示文字

**語法**：`[[文件名稱|顯示文字]]`

**範例**：
```markdown
[[Rust 所有權|ownership]]
[[C++ 指標#指標危險性|指針危險性]]
```

**支援範圍**：
- ✅ 識別真實目標：`文件名稱`
- ✅ 顯示文字：`顯示文字`
- ✅ UI 顯示使用顯示文字
- ✅ 搜尋索引包含兩者

**實作策略**：
- 正則表達式：`\[\[([^\]|#]+?)\|([^\]]+?)\]\]`
- 儲存：target = "文件名稱", display = "顯示文字"
- 建立雙向關聯

**測試案例**：
- 檔案：`Card卡片盒/學習/程式/Rust/Rust 所有權.md`
- 範例：`[[C++ 指標#指標危險性|指針危險性]]`
- 預期：連結到 "C++ 指標"，顯示 "指針危險性"

---

##### 2.3 Wikilink 帶標題錨點

**語法**：`[[文件名稱#標題]]`

**範例**：
```markdown
[[Rust 所有權#作用域]]
[[Rust std標準庫 Trait#實作Error (std error Error)|實作Error]]
```

**支援範圍**：
- ✅ 識別目標文件：`文件名稱`
- ✅ 識別目標標題：`標題`
- ⚠️ V1 不跳轉到具體標題位置（降級為文件級連結）
- ✅ 標題資訊用於相關性計分

**實作策略**：
- 正則表達式：`\[\[([^#\]|]+)#([^\]|]+?)(\|([^\]]+?))?\]\]`
- 提取：document, heading, display (optional)
- V1 連結到文件層級，V2+ 支援標題層級跳轉

**測試案例**：
- 檔案：`Atlas地圖集/MOC/Rust MOC.md`
- 範例：`[[Rust std標準庫 Trait#實作Error (std error Error)|實作Error]]`
- 預期：連結到 "Rust std標準庫 Trait"，記錄 heading 為 "實作Error"

---

#### 3. 標籤

**描述**：主題分類標記

**語法**：`#tag` 或 `#parent/child`

**範例**：
```markdown
#程式語言/Rust
#學習筆記
#rust #programming
```

**支援範圍**：
- ✅ 單層標籤：`#rust`
- ✅ 巢狀標籤：`#程式語言/Rust`
- ✅ 行內多標籤
- ✅ 標籤索引與搜尋
- ✅ 標籤雲視覺化（Phase 3）

**實作策略**：
- 正則表達式：`#([\p{L}\p{N}_/-]+)`（支援中文、數字、底線、斜線）
- 提取所有標籤到 Document.tags
- 建立標籤反向索引：Tag → [Documents]
- 巢狀標籤拆分：`程式語言/Rust` → `["程式語言", "程式語言/Rust"]`

**測試案例**：
- 檔案：多個 Rust 文件
- 預期：所有包含 `#程式語言/Rust` 的文件被標記

---

#### 4. 基本 Markdown 語法

**支援範圍**：

| 語法 | 範例 | 支援 | 備註 |
|------|------|------|------|
| 標題 | `# 標題` | ✅ | 用於文件結構解析 |
| 粗體 | `**粗體**` | ✅ | 保留格式 |
| 斜體 | `*斜體*` | ✅ | 保留格式 |
| 程式碼區塊 | ` ```rust ``` ` | ✅ | 保留完整格式 |
| 行內程式碼 | `` `code` `` | ✅ | 保留格式 |
| 引用 | `> 引用` | ✅ | 保留格式 |
| 清單（有序） | `1. 項目` | ✅ | 保留結構 |
| 清單（無序） | `- 項目` | ✅ | 保留結構 |
| 連結 | `[text](url)` | ✅ | 標準 Markdown |
| 圖片 | `![alt](path)` | ✅ | 參見下方 |
| 表格 | `\| A \| B \|` | ✅ | 保留完整表格 |
| 水平線 | `---` | ✅ | 保留 |
| 刪除線 | `~~刪除~~` | ✅ | 保留格式 |

**實作策略**：
- 使用成熟的 Markdown parser（如 Python `markdown` 或 Rust `pulldown-cmark`）
- 保留原始格式用於顯示
- 提取純文字用於向量化

---

#### 5. 圖片連結（Obsidian 風格）

**描述**：帶尺寸參數的圖片

**語法**：`![寬度](路徑)` 或 `![寬度x高度](路徑)`

**範例**：
```markdown
![100](../../Source來源筆記/圖片/Rust%20MOC/1_e7M8FpQYZVLsBGTiP8Cbvg.png)
![100](../../Source來源筆記/圖片/Rust%20MOC/Pasted%20image%2020240212150049.png)
```

**支援範圍**：
- ✅ 識別圖片路徑
- ✅ 解析相對路徑
- ✅ OCR 文字提取（Phase 1, PaddleOCR）
- ✅ 圖片預覽（UI）
- ⚠️ 尺寸參數：V1 忽略，V2+ 支援

**實作策略**：
- 正則表達式：`!\[(\d+(?:x\d+)?)\]\(([^)]+)\)`
- 解析相對路徑為絕對路徑
- OCR 文字作為圖片的 metadata.ocr_text
- 圖片資訊納入向量化

**測試案例**：
- 檔案：`Atlas地圖集/MOC/Rust MOC.md`
- 範例：`![100](../../Source來源筆記/圖片/Rust%20MOC/1_e7M8FpQYZVLsBGTiP8Cbvg.png)`
- 預期：識別圖片，執行 OCR，提取文字

---

### ⚠️ 降級支援（Priority 2）

這些語法將被簡化處理，保留內容但移除特殊格式。

#### 1. 程式碼區塊標題（Obsidian 擴展）

**語法**：` ```language title:"標題" `

**範例**：
```markdown
 ```Rust title:"作用域"
fn main() {
    let a: i32 = 1;
}
 ```
```

**降級策略**：
- ✅ 保留程式碼內容
- ✅ 保留語言標記（`Rust`）
- ⚠️ 忽略 `title:` 參數
- 顯示為標準程式碼區塊

**測試案例**：
- 檔案：`Card卡片盒/學習/程式/Rust/Rust 所有權.md`
- 預期：程式碼正確顯示，title 不影響功能

---

#### 2. Callouts / Admonitions

**語法**：
```markdown
> [!note] 標題
> 內容

> [!warning] 注意
> 警告內容
```

**降級策略**：
- ✅ 保留內容文字
- ⚠️ 移除 `[!type]` 標記
- 轉為標準 Markdown 引用 `>`

**實作**：
```markdown
# 原始
> [!note] 重要概念
> 這是一個重要的筆記

# 降級後
> 重要概念
> 這是一個重要的筆記
```

---

#### 3. 任務清單（進階）

**語法**：
```markdown
- [x] 已完成 ✅ 2026-02-17
- [ ] 待完成 📅 2026-02-20
```

**降級策略**：
- ✅ 保留基本任務狀態：`- [x]` / `- [ ]`
- ⚠️ 忽略日期和 emoji
- 顯示為標準 Markdown 任務清單

---

#### 4. 嵌入內容

**語法**：`![[其他文件]]`

**範例**：
```markdown
![[Rust 所有權]]
![[圖片.png]]
```

**降級策略**：
- ⚠️ V1 不嵌入實際內容
- ✅ 轉為標準連結：`[[其他文件]]`
- ✅ 仍建立文件關聯
- V2+ 支援真實嵌入

**實作**：
```markdown
# 原始
![[Rust 所有權]]

# 降級後
參見：[[Rust 所有權]]
```

---

#### 5. 區塊引用

**語法**：`[[文件名稱#^區塊id]]`

**範例**：
```markdown
[[Rust 所有權#^ownership-rule-1]]
```

**降級策略**：
- ⚠️ V1 不支援區塊級連結
- ✅ 降級為文件級連結：`[[Rust 所有權]]`
- ✅ 保留區塊 ID 資訊在 metadata
- V2+ 支援區塊級跳轉

---

### ❌ 不支援（Priority 3）

這些語法 V1 不處理，直接顯示為純文字或移除。

#### 1. Dataview 查詢

**語法**：
```dataview
TABLE file.name, file.mtime
FROM #程式語言/Rust
SORT file.mtime DESC
```

**處理方式**：
- ❌ 不執行查詢
- 顯示為程式碼區塊（純文字）
- 不影響文件索引

---

#### 2. Canvas（畫布）

**描述**：Obsidian 的視覺化白板功能

**處理方式**：
- ❌ `.canvas` 檔案不處理
- V1 僅處理 `.md` 檔案

---

#### 3. Excalidraw 圖表

**處理方式**：
- ❌ 不解析 Excalidraw 語法
- 如有嵌入，顯示為連結

---

#### 4. 複雜外掛語法

**範例**：
- Templater: `<%...%>`
- Dataview inline: `$= ...`
- 其他社群外掛

**處理方式**：
- ❌ 直接顯示為純文字
- 不影響功能

---

#### 5. LaTeX 數學公式（可選）

**語法**：
```markdown
$$
E = mc^2
$$
```

**處理方式**：
- ❌ V1 不渲染
- 保留原始文字
- 📝 備註：V2 可考慮支援（MathJax/KaTeX）

---

## 語法優先順序總結

| 優先級 | 類別 | 範例 | 影響功能 |
|--------|------|------|----------|
| P1 | YAML Frontmatter | `tags:`, `aliases:` | 索引、搜尋 |
| P1 | Wikilinks | `[[文件]]` | 知識圖譜核心 |
| P1 | 標籤 | `#rust` | 分類、搜尋 |
| P1 | 基本 Markdown | `# 標題`, `**粗體**` | 內容顯示 |
| P1 | 圖片（Obsidian） | `![100](path)` | OCR、視覺化 |
| P2 | 程式碼標題 | `title:"..."` | 不影響核心功能 |
| P2 | Callouts | `> [!note]` | 降級為引用 |
| P2 | 嵌入 | `![[文件]]` | 轉為連結 |
| P3 | Dataview | `TABLE...` | 純文字顯示 |
| P3 | Canvas | `.canvas` | 不處理 |

---

## 實作檢查清單

### Phase 1：核心語法（必須）

- [ ] YAML Frontmatter 解析器
  - [ ] tags 提取與索引
  - [ ] aliases 提取
  - [ ] 自定義欄位（來源、日期）
  
- [ ] Wikilinks 解析器
  - [ ] 基本 wikilink: `[[文件]]`
  - [ ] 帶顯示文字: `[[文件|文字]]`
  - [ ] 帶標題: `[[文件#標題]]`
  - [ ] 綜合: `[[文件#標題|文字]]`
  
- [ ] 標籤解析器
  - [ ] 單層標籤
  - [ ] 巢狀標籤（含中文）
  - [ ] 標籤索引建立
  
- [ ] 圖片處理
  - [ ] Obsidian 尺寸語法識別
  - [ ] 相對路徑解析
  - [ ] OCR 整合

- [ ] Markdown 基本語法
  - [ ] 標題結構提取
  - [ ] 內容分塊（chunking）
  - [ ] 純文字提取（向量化）

### Phase 2：降級支援（建議）

- [ ] 程式碼區塊 title 移除
- [ ] Callouts 轉標準引用
- [ ] 嵌入轉連結
- [ ] 任務清單日期移除

### Phase 3：測試驗證

- [ ] 單元測試：各語法解析正確性
- [ ] 整合測試：完整文件解析
- [ ] 效能測試：43 個文件處理時間
- [ ] 邊界測試：特殊字元、中文路徑

---

## 測試資料語法統計

基於 `apps/issue-3/data/test-data/` 的實際分析：

| 語法類型 | 出現次數（估計） | 優先級 |
|----------|------------------|--------|
| YAML Frontmatter | ~35 files | P1 |
| Wikilinks 基本 | 200+ | P1 |
| Wikilinks 標題 | 50+ | P1 |
| 標籤（巢狀） | 100+ | P1 |
| 圖片（尺寸） | 20+ | P1 |
| 程式碼區塊標題 | 30+ | P2 |
| Callouts | 5-10 | P2 |
| Dataview | 0 | P3 |

---

## 邊界情況處理

### 1. 檔名特殊字元

**問題**：`[[C++ 指標]]` vs `[[Rust match & if let]]`

**處理**：
- 空格：保留
- 特殊字元（`+`, `&`）：保留
- 檔案系統對應：URL 編碼處理

### 2. 中文路徑

**問題**：`Card卡片盒/學習/程式/`

**處理**：
- UTF-8 編碼確保
- 路徑正規化
- 測試各作業系統相容性

### 3. 循環引用

**問題**：A → B → A

**處理**：
- 圖譜視覺化檢測循環
- 不影響索引建立
- UI 提供循環標示

### 4. 大小寫敏感

**問題**：`[[Rust]]` vs `[[rust]]`

**處理**：
- Windows：不區分大小寫（檔案系統）
- 搜尋：提供選項（預設不區分）
- 索引：正規化為小寫

---

## 效能考量

### 解析效能目標

- 單一文件解析：< 100ms
- 43 個測試文件：< 5 秒
- 增量更新：< 1 秒

### 最佳化策略

1. **快取機制**
   - 快取解析結果（基於檔案 hash）
   - 僅重新解析變更文件

2. **平行處理**
   - 多檔案並行解析
   - 獨立文件無依賴

3. **懶載入**
   - 索引階段僅解析語法
   - 全文內容按需載入

---

## 更新記錄

- **2026-02-17**：初版建立，基於測試資料分析
- **待更新**：Phase 1 實作後的實際調整

---

## 參考資源

- [Obsidian Help - Links](https://help.obsidian.md/Linking+notes+and+files/Internal+links)
- [Obsidian Help - Metadata](https://help.obsidian.md/Editing+and+formatting/Metadata)
- [CommonMark Spec](https://commonmark.org/)
- 測試資料：`apps/issue-3/data/test-data/`

---

**狀態**：✅ 完成  
**下一步**：實作 Phase 1 核心語法解析器  
**預計影響**：Phase 1 開發（Week 3-6）
