---
tags: 程式語言/Rust  
aliases: 
來源: 
- "[[Rust 權威指南]]"
- "[[Rust 编程语言入门教程 2021]]"
- "[[為你自己學 Rust 系列]]"
- "[[Rust 所有權]]"
新建日期: 2024-03-30 21:44:27
---

# 概念

這是Rust裡最重要的概念，跟[[Rust 所有權]]同等重要
概念上要先提[[C++ 指標|指針]]，很多錯誤都發生在，
引用到錯誤的記憶體位置或是出現[[Rust 引用#懸垂引用|懸垂引用]]
所以Rust引進了生命週期概念，
其實就一句話，`你這變數，你不准死，你死後面怎辦`
用來防止出現懸空指針，或是錯誤的記憶體位置

# 借用檢查器

概念簡單，就是檢查每一變數的生命長短
如果出現太短或是其他問題，就阻止編譯
下面這案例就是出現說，`'b`週期比`'a`小，並且`變數 r `借用到`'b`裡的東西
那這樣會導致出現懸空指針，所以就不准編譯

```rust title:"借用檢查器範例"
fn main() {
    let r;                // ---------+-- 'a
                          //          |
    {                     //          |
        let x = 5;        // -+-- 'b  |
        r = &x;           //  |       |
    }                     // -+       |
                          //          |
    println!("r: {}", r); //          |
}                         // ---------+
```

## 函數借用檢查

函式也會進行檢查，檢查範圍包含
`函式的輸入參數`、`內部變數`、`輸出結果`
其實這也蠻好理解，如果輸入有問題，當然會出事
內部和輸出也是一樣
像下面這函式過不了編譯，原因在於
檢查器不會知道，最後輸出的是`x`還是`y`所以無法定義生命週期範圍
如果隨意輸出，那就有可能出現[[Rust 引用#懸垂引用|懸垂引用]]

```rust titile:"借用檢查器範例2"
fn longest(x: &str, y: &str) -> &str {
    if x.len() > y.len() { // ---------+-- 'a
        x                  //          |
    }                      // ---------+ 
    else 
    {               
						   // ---------+-- 'b
        y                  //          |
    }                      // ---------+
    //編譯不給過，在於檢查器不知道是輸出x還是y
    //因為 'a 'b 都被侷限了，有可能輸出時才發現被釋放掉
}
```

### 生命週期註解

那出現檢查器不給過怎辦，就要特別幫引用打上**生命週期註解**
讓檢查器知道是怎麼回事
就是在 **&** 符號後面加上 ** '(撇號)+任意字母 **
只有一點`'static`這個是關鍵字不要亂用

```rust title:"生命週期註解"
&i32 // 引用 
&'a i32 // 带有显式生命周期的引用 
&'a mut i32 // 带有显式生命周期的可变引用
```

那這代表啥意思，
代表**我們幾個要活一起活**
也就是跟解釋器說，這些變數的生命週期，是一起的
以下面為例，變數、輸出都是`'a`
就代表，這變數要活到輸出，這樣即使不知道輸出是x或是y
至少解釋器可以確定說，x y 會活到輸出，才要釋放
那這樣解釋器就可以放心編譯
那`'static`意思是，這變數生命週期要**活到程式結束**為止(關閉的那種結束)

```rust title:"生命週期註解範例"
fn longest<'a>(x: &'a str, y: &'a str) -> &'a str {
    if x.len() > y.len() {    // ---------+-- 'a
        x                     //          |
    } else {                  //          |
        y                     //          |
    }                         //          |
                              // ---------+ 
    //有了週期註解，代表 x y至少要活到輸出，這樣編譯器就放心編譯
    //因為x y都被規定了週期，所以就不像上面範例一樣，
    //週期是一起的，所以檢查器就給過
}
```


>[!abstract] 小結
> 其實生命週期有一套嚴格的定義方式
> 但[[Rust 權威指南]] 並沒有描述
> 反倒是 https://youtu.be/vC27FlmBLXk?si=wRumKgVBsB9LeO4E
> 影片裡有描述，如果看不懂，可以看看影片

